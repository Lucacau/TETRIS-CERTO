<!DOCTYPE html>
<html lang="PT-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tetris</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.0/css/dataTables.dataTables.css"> 
    <style>
        :root{
            --corPagina: rgb(0, 4, 255);  ;
        }
        *{
            margin: 0;
            box-sizing: border-box;
        }
        @font-face {
            font-family: Arcade_I;
            src: url(/TETRIS-SUPREMO/fonts/ARCADE_I.TTF);
        }
        @font-face {
            font-family: Arcade_N;
            src: url(/TETRIS-SUPREMO/fonts/ARCADE_N.TTF);
        }
        @font-face {
            font-family: Arcade_R;
            src: url(/TETRIS-SUPREMO/fonts/ARCADE_R.TTF);
        }
        body{  
            background: black;
            font-family: Arcade_N;  
            font-size: 18px;
        }  
        .tudo{
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            margin-top: 40px;
            
        }
        #tetris{  
            border: solid 0.2em var(--corPagina);  
            height: 90vh;
        }  
        #nextPiece{
            border: solid 0.2em var(--corPagina);  
            height: 25vh;
        }
        #comandos{
            font-family: Arcade_N;
            background-color: var(--corPagina);  
            color: white;
            border: 10px;
            border-radius: 10px;
            height: 50px;
            cursor: pointer;
            width: 150px;
            outline: none;
        }
        #comandos-box {
            left: 50%;
            font-size: 10px;
            display: none;
            position: relative;
            background-color: #020202;
            color: white;
            border: 2px solid white;
            border-radius: 5px;
            transform: translateX(-50%);
        }
        .botoes{
            display: flex;
            flex-direction: column;
            gap: 30px;
            align-items: center;
        }
        #startButton{
            font-family: Arcade_N;
            background-color: var(--corPagina);  
            color: white;
            border: 10px;
            border-radius: 10px;
            height: 50px;
            cursor: pointer;
            width: 150px;
            outline: none;
        }
        #gameOverScreen {
            display: none;
            position: fixed;
            text-align: center;
            top: 43%;
            left: 50.5%;
            transform: translate(-50%, -50%);
            color: white;
        }
        #logo{
            height: 150px;
        }
        .cartao{
            font-size: 14px;
            width: 217px;
            position: relative;
            background-clip: border-box;
            color: var(--corPagina);
            text-align: center;
        }
        #score{
            color: var(--corPagina);  
        }
        #botao-score{
            display: flex;
            align-items: center;
            font-family: Arcade_N;
            background-color: var(--corPagina);  
            color: white;
            border: 10px;
            border-radius: 10px;
            height: 50px;
            cursor: pointer;
            width: 150px;
            outline: none;   
        }
        .corpo-modal{
            display: flex;
            align-items: center;
            justify-content: center;
        }
        @media (min-width: 576px){
        .modal-dialog {
            max-width: 1227px;
            margin: 1.75rem auto;
            padding-block-end: 10px;
        }}
        @media (min-width: 576px){
        .modal-dialog {
            padding: 80px;
        }}
        .modal-content {
            color: var(--corPagina);  
            position: relative;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -ms-flex-direction: column;
            flex-direction: column;
            width: 100%;
            pointer-events: auto;
            background-color: #ffffff;
            background-clip: padding-box;
            border: 1px solid rgba(0,0,0,.2);
            border-radius: 0.3rem;
            outline: 0;
            padding: 37px;
        }
        .leftside{
            display: flex;
            flex-direction: column;
            gap: 30px;            
        }
        #canva-score{
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        table.dataTable thead th, table.dataTable thead td, table.dataTable tfoot th, table.dataTable tfoot td {
        text-align: center;
        }
        table.dataTable th.dt-type-numeric, table.dataTable th.dt-type-date, table.dataTable td.dt-type-numeric, table.dataTable td.dt-type-date {
        text-align: center;
        }
        .botao-de-exclusao{
            height: 25px;
            width: 25px;
            border: none;
            background: linear-gradient(68.15deg, #4c92ad 16.62%, #9cc5c7 85.61%);
            background-image: url(/TETRIS-SUPREMO/img/icone-fermer-et-x-rouge.png);
            background-size: cover;
            cursor:pointer
        }
        #nivel{
            color: var(--corPagina);
        }
    </style>
</head>
<body>
    <div class="tudo">
        <div id="gameOverScreen" style="display: none;">
            <h1>Game Over!</h1>
        </div>
        <div class="leftside">
            <div id="canva-score">
                <div id="score"></div>
                <div id="nivel"></div>
                <canvas id="nextPiece" width="80" height="80"></canvas>
            </div>
            <img src="/TETRIS-SUPREMO/img/tetris-logo.png" id="logo">
            <div class="botoes">
                <button onclick="start(), buttonClickSound()" id="startButton">Start</button>
                <button onclick= "buttonClickSound()" id="comandos" data-toggle="collapse" data-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
                    Comandos
                </button>
                <div class="collapse" id="collapseExample">
                    <div class="cartao">
                        < >: Mover<br>
                        🡣: Descer<br>
                        A: Sentido Anti-Horario<br>
                        D: Sentido Horario<br>
                        Espaco: Hard Drop
                    </div>
                </div>
                <button onclick= "buttonClickSound()" type="button" id="botao-score" data-toggle="modal" data-target=".bd-example-modal-lg">
                    Score Board
                </button> 
                <div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <table id="example" class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Sobrenome</th>
                                    <th>Level</th>
                                    <th>Score</th>
                                    <th>Data</th>
                                    <th>Excluir</th>
                                </tr>
                            </thead>
                            <tbody id="scoreboardBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                </div>
            </div>
        </div>
        <div class="rightSide">
            <canvas id="tetris" width="240" height="400"></canvas>
        </div>
    </div>
    <audio id="gameOverSound" src="/audios/Arcade retro game over sound effect (FREE)_gdrQrCOSFfI.mp3"></audio>
    <audio id="tetrisDropSound" src="/audios/minecraft-item-drop-sound-effect-pgpbe9afed4_YItRJKGt.mp3"></audio>
    <audio id="tetrisBackgroundMusic" src="/audios/Animal Crossing_ City Folk- 2 AM_YsDM3UvXWOc.mp3" loop></audio>
    <audio id="buttonSound" src="/audios/button-plate-click-minecraft-sound-sound-effect-for-editing-h8y0jmvwdmm_F41koB79.mp3"></audio>
    <audio id="lineClear" src="/audios/tetris-game-boy-line-clear-sound-effects-lddsf4szgjw_S9wGjWBw.mp3"></audio>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="//cdn.datatables.net/2.0.0/js/dataTables.js"></script>
    <script>
        let scoreboardTable;
        $(document).ready(function() {
            scoreboardTable = $('#example').DataTable({
                language: {
                    "emptyTable": "Nenhum registro encontrado",
                    "info": "",
                    "infoFiltered": "(Filtrados de _MAX_ registros)",
                    "infoThousands": ".",
                    "loadingRecords": "Carregando...",
                    "zeroRecords": "Nenhum registro encontrado",
                    "search": "",
                    "paginate": {
                        "next": "",
                        "previous": "",
                        "first": "",
                        "last": ""
                    },
                    "aria": {
                        "sortAscending": ": Ordenar colunas de forma ascendente",
                        "sortDescending": ": Ordenar colunas de forma descendente"
                    },
                    "select": {
                        "rows": {
                            "_": "Selecionado %d linhas",
                            "1": "Selecionado 1 linha"
                        },
                        "cells": {
                            "1": "1 célula selecionada",
                            "_": "%d células selecionadas"
                        },
                        "columns": {
                            "1": "1 coluna selecionada",
                            "_": "%d colunas selecionadas"
                        }
                    },
                    "buttons": {
                        "copySuccess": {
                            "1": "Uma linha copiada com sucesso",
                            "_": "%d linhas copiadas com sucesso"
                        },
                        "collection": "Coleção  <span class=\"ui-button-icon-primary ui-icon ui-icon-triangle-1-s\"><\/span>",
                        "colvis": "Visibilidade da Coluna",
                        "colvisRestore": "Restaurar Visibilidade",
                        "copy": "Copiar",
                        "copyKeys": "Pressione ctrl ou u2318 + C para copiar os dados da tabela para a área de transferência do sistema. Para cancelar, clique nesta mensagem ou pressione Esc..",
                        "copyTitle": "Copiar para a Área de Transferência",
                        "csv": "CSV",
                        "excel": "Excel",
                        "pageLength": {
                            "-1": "Mostrar todos os registros",
                            "_": "Mostrar %d registros"
                        },
                        "pdf": "PDF",
                        "print": "Imprimir",
                        "createState": "Criar estado",
                        "removeAllStates": "Remover todos os estados",
                        "removeState": "Remover",
                        "renameState": "Renomear",
                        "savedStates": "Estados salvos",
                        "stateRestore": "Estado %d",
                        "updateState": "Atualizar"
                    },
                    "autoFill": {
                        "cancel": "Cancelar",
                        "fill": "Preencher todas as células com",
                        "fillHorizontal": "Preencher células horizontalmente",
                        "fillVertical": "Preencher células verticalmente"
                    },
                    "lengthMenu": "",
                    "searchBuilder": {
                        "add": "Adicionar Condição",
                        "button": {
                            "0": "Construtor de Pesquisa",
                            "_": "Construtor de Pesquisa (%d)"
                        },
                        "clearAll": "Limpar Tudo",
                        "condition": "Condição",
                        "conditions": {
                            "date": {
                                "after": "Depois",
                                "before": "Antes",
                                "between": "Entre",
                                "empty": "Vazio",
                                "equals": "Igual",
                                "not": "Não",
                                "notBetween": "Não Entre",
                                "notEmpty": "Não Vazio"
                            },
                            "number": {
                                "between": "Entre",
                                "empty": "Vazio",
                                "equals": "Igual",
                                "gt": "Maior Que",
                                "gte": "Maior ou Igual a",
                                "lt": "Menor Que",
                                "lte": "Menor ou Igual a",
                                "not": "Não",
                                "notBetween": "Não Entre",
                                "notEmpty": "Não Vazio"
                            },
                            "string": {
                                "contains": "Contém",
                                "empty": "Vazio",
                                "endsWith": "Termina Com",
                                "equals": "Igual",
                                "not": "Não",
                                "notEmpty": "Não Vazio",
                                "startsWith": "Começa Com",
                                "notContains": "Não contém",
                                "notStartsWith": "Não começa com",
                                "notEndsWith": "Não termina com"
                            },
                            "array": {
                                "contains": "Contém",
                                "empty": "Vazio",
                                "equals": "Igual à",
                                "not": "Não",
                                "notEmpty": "Não vazio",
                                "without": "Não possui"
                            }
                        },
                        "data": "Data",
                        "deleteTitle": "Excluir regra de filtragem",
                        "logicAnd": "E",
                        "logicOr": "Ou",
                        "title": {
                            "0": "Construtor de Pesquisa",
                            "_": "Construtor de Pesquisa (%d)"
                        },
                        "value": "Valor",
                        "leftTitle": "Critérios Externos",
                        "rightTitle": "Critérios Internos"
                    },
                    "searchPanes": {
                        "clearMessage": "Limpar Tudo",
                        "collapse": {
                            "0": "Painéis de Pesquisa",
                            "_": "Painéis de Pesquisa (%d)"
                        },
                        "count": "{total}",
                        "countFiltered": "{shown} ({total})",
                        "emptyPanes": "Nenhum Painel de Pesquisa",
                        "loadMessage": "Carregando Painéis de Pesquisa...",
                        "title": "Filtros Ativos",
                        "showMessage": "Mostrar todos",
                        "collapseMessage": "Fechar todos"
                    },
                    "thousands": ".",
                    "datetime": {
                        "previous": "Anterior",
                        "next": "Próximo",
                        "hours": "Hora",
                        "minutes": "Minuto",
                        "seconds": "Segundo",
                        "amPm": [
                            "am",
                            "pm"
                        ],
                        "unknown": "-",
                        "months": {
                            "0": "Janeiro",
                            "1": "Fevereiro",
                            "10": "Novembro",
                            "11": "Dezembro",
                            "2": "Março",
                            "3": "Abril",
                            "4": "Maio",
                            "5": "Junho",
                            "6": "Julho",
                            "7": "Agosto",
                            "8": "Setembro",
                            "9": "Outubro"
                        },
                        "weekdays": [
                            "Dom",
                            "Seg",
                            "Ter",
                            "Qua",
                            "Qui",
                            "Sex",
                            "Sáb"
                        ]
                    },
                    "editor": {
                        "close": "Fechar",
                        "create": {
                            "button": "Novo",
                            "submit": "Criar",
                            "title": "Criar novo registro"
                        },
                        "edit": {
                            "button": "Editar",
                            "submit": "Atualizar",
                            "title": "Editar registro"
                        },
                        "error": {
                            "system": "Ocorreu um erro no sistema (<a target=\"\\\" rel=\"nofollow\" href=\"\\\">Mais informações<\/a>)."
                        },
                        "multi": {
                            "noMulti": "Essa entrada pode ser editada individualmente, mas não como parte do grupo",
                            "restore": "Desfazer alterações",
                            "title": "Multiplos valores",
                            "info": "Os itens selecionados contêm valores diferentes para esta entrada. Para editar e definir todos os itens para esta entrada com o mesmo valor, clique ou toque aqui, caso contrário, eles manterão seus valores individuais."
                        },
                        "remove": {
                            "button": "Remover",
                            "confirm": {
                                "_": "Tem certeza que quer deletar %d linhas?",
                                "1": "Tem certeza que quer deletar 1 linha?"
                            },
                            "submit": "Remover",
                            "title": "Remover registro"
                        }
                    },
                    "decimal": ",",
                    "stateRestore": {
                        "creationModal": {
                            "button": "Criar",
                            "columns": {
                                "search": "Busca de colunas",
                                "visible": "Visibilidade da coluna"
                            },
                            "name": "Nome:",
                            "order": "Ordernar",
                            "paging": "Paginação",
                            "scroller": "Posição da barra de rolagem",
                            "search": "Busca",
                            "searchBuilder": "Mecanismo de busca",
                            "select": "Selecionar",
                            "title": "Criar novo estado",
                            "toggleLabel": "Inclui:"
                        },
                        "emptyStates": "Nenhum estado salvo",
                        "removeConfirm": "Confirma remover %s?",
                        "removeJoiner": "e",
                        "removeSubmit": "Remover",
                        "removeTitle": "Remover estado",
                        "renameButton": "Renomear",
                        "renameLabel": "Novo nome para %s:",
                        "renameTitle": "Renomear estado",
                        "duplicateError": "Já existe um estado com esse nome!",
                        "emptyError": "Não pode ser vazio!",
                        "removeError": "Falha ao remover estado!"
                    },
                    "infoEmpty": "",
                    "processing": "Carregando...",
                    "searchPlaceholder": "Buscar registros"
                },
                order: [
                    [3, 'desc'],
                    [2, 'desc'],
                    [4, 'asc'],
                    [0, 'asc'],
                ]
            });
            loadScoreboardData();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script>
        "use strict";
        document.addEventListener('DOMContentLoaded', function() {
        const tetrisBackSound = document.getElementById('tetrisBackgroundMusic');
            tetrisBackSound.addEventListener('loadedmetadata', function() {
                tetrisBackSound.volume = 0.7
                tetrisBackSound.play();
            });
        });
        const buttonClick = document.getElementById('buttonSound');
        const gameOverSound = document.getElementById('gameOverSound');
        const tetrisDrop = document.getElementById('tetrisDropSound');
        const clearSound = document.getElementById('lineClear');
        const canvas = document.getElementById("tetris");
        const botaoStart = document.getElementById('startButton');
        const context = canvas.getContext("2d");
        context.scale(20, 20);  

        function arenaSweep() {  
            let rowCount = 1;  
            outer: for (let y = arena.length - 1; y > 0; --y) {  
                for (let x = 0; x < arena[y].length; ++x) {  
                    if (arena[y][x] === 0) {  
                        continue outer;  
                    }  
                }
                const row = arena.splice(y, 1)[0].fill(0);  
                arena.unshift(row);  
                ++y;  
                lineClearSound();
                player.score += rowCount * 10;  
                rowCount *= 3;  
            }  
        }  
        function collide(arena, player) {  
            const m = player.matrix;  
            const o = player.pos;  
            for (let y = 0; y < m.length; ++y) {  
                for (let x = 0; x < m[y].length; ++x) {  
                    if (m[y][x] !== 0 && (arena[y + o.y] && arena[y + o.y][x + o.x]) !== 0) {  
                        return true;  
                    }  
                }  
            }  
            return false;  
        }  
        function createMatrix(w, h) {  
            const matrix = [];  
            while (h--) {  
                matrix.push(new Array(w).fill(0));  
            }  
            return matrix;  
        }  
        function createPiece(type) {  
            if (type === "I") {  
                return [  
                    [0, 1, 0, 0],  
                    [0, 1, 0, 0],  
                    [0, 1, 0, 0],  
                    [0, 1, 0, 0],  
                ];  
            } else if (type === "L") {  
                return [  
                    [0, 2, 0],  
                    [0, 2, 0],  
                    [0, 2, 2],  
                ];  
            } else if (type === "J") {  
                return [  
                    [0, 3, 0],  
                    [0, 3, 0],  
                    [3, 3, 0],  
                ];  
            } else if (type === "O") {  
                return [  
                    [4, 4],  
                    [4, 4],  
                ];  
            } else if (type === "Z") {  
                return [  
                    [5, 5, 0],  
                    [0, 5, 5],  
                    [0, 0, 0],  
                ];  
            } else if (type === "S") {  
                return [  
                    [0, 6, 6],  
                    [6, 6, 0],  
                    [0, 0, 0],  
                ];  
            } else if (type === "T") {  
                return [  
                    [0, 7, 0],  
                    [7, 7, 7],  
                    [0, 0, 0],  
                ];  
            }  
        }  
        function drawMatrix(matrix, offset) {  
            matrix.forEach((row, y) => {  
                row.forEach((value, x) => {  
                    if (value !== 0) {
                        const gradient = context.createLinearGradient(x + offset.x, y + offset.y, x + offset.x + 1, y + offset.y + 1);
                        switch(value) {
                            case 1: // Peça I (Vermelho neon)
                                gradient.addColorStop(0, '#FF3E4D');
                                gradient.addColorStop(1, '#FFA07A');
                                break;
                            case 2: // Peça L (Azul neon)
                                gradient.addColorStop(0, '#00FFFF');
                                gradient.addColorStop(1, '#6A5ACD');
                                break;
                            case 3: // Peça J (Verde neon)
                                gradient.addColorStop(0, '#39DF14');
                                gradient.addColorStop(1, '#000F7F');
                                break;
                            case 4: // Peça O (Amarelo neon)
                                gradient.addColorStop(0, '#FFFF00');
                                gradient.addColorStop(1, '#FF6700');
                                break;
                            case 5: // Peça Z (Roxo neon)
                                gradient.addColorStop(0, '#BF04FF');
                                gradient.addColorStop(1, '#0122CC');
                                break;
                            case 6: // Peça S (Rosa neon)
                                gradient.addColorStop(0, '#FF1493');
                                gradient.addColorStop(1, '#FF69B4');
                                break;
                            case 7: // Peça T (Laranja neon)
                                gradient.addColorStop(0, '#FFA500');
                                gradient.addColorStop(1, '#FF4500');
                                break;
                        }
                        context.fillStyle = gradient;
                        context.fillRect(x + offset.x, y + offset.y, 1, 1);
                        context.fillStyle = 'rgba(255, 255, 255, 0.05)';
                        context.fillRect(x + offset.x, y + offset.y, 1, 1);
                    }  
                });  
            });  
        }

        function drawNextPiece(piece) {
            const canvasNextPiece = document.getElementById("nextPiece");
            const contextNextPiece = canvasNextPiece.getContext("2d"); 

            contextNextPiece.clearRect(0, 0, canvasNextPiece.width, canvasNextPiece.height);

            const cellSize = canvasNextPiece.width / 5;
            const offsetX = (canvasNextPiece.width - piece[0].length * cellSize) / 2;
            const offsetY = (canvasNextPiece.height - piece.length * cellSize) / 2; 
            piece.forEach((row, y) => {
                row.forEach((value, x) => {
                    if (value !== 0) {
                        const gradient = contextNextPiece.createLinearGradient(x * cellSize + offsetX, y * cellSize + offsetY, (x + 1) * cellSize + offsetX, (y + 1) * cellSize + offsetY);
                        switch (value) {
                            case 1: // Peça I (Vermelho neon)
                                gradient.addColorStop(0, '#FF3E4D');
                                gradient.addColorStop(1, '#FFA07A');
                                break;
                            case 2: // Peça L (Azul neon)
                                gradient.addColorStop(0, '#00FFFF');
                                gradient.addColorStop(1, '#6A5ACD');
                                break;
                            case 3: // Peça J (Verde neon)
                                gradient.addColorStop(0, '#39DF14');
                                gradient.addColorStop(1, '#000F7F');
                                break;
                            case 4: // Peça O (Amarelo neon)
                                gradient.addColorStop(0, '#FFFF00');
                                gradient.addColorStop(1, '#FF6700');
                                break;
                            case 5: // Peça Z (Roxo neon)
                                gradient.addColorStop(0, '#BF04FF');
                                gradient.addColorStop(1, '#0122CC');
                                break;
                            case 6: // Peça S (Rosa neon)
                                gradient.addColorStop(0, '#FF1493');
                                gradient.addColorStop(1, '#FF69B4');
                                break;
                            case 7: // Peça T (Laranja neon)
                                gradient.addColorStop(0, '#FFA500');
                                gradient.addColorStop(1, '#FF4500');
                                break;
                        }
                        contextNextPiece.fillStyle = gradient;
                        contextNextPiece.fillRect(x * cellSize + offsetX, y * cellSize + offsetY, cellSize, cellSize);
                        contextNextPiece.fillStyle = 'rgba(255, 255, 255, 0.05)';
                        contextNextPiece.fillRect(x * cellSize + offsetX, y * cellSize + offsetY, cellSize, cellSize);
                    }
                });
            });
        }

        function buttonClickSound(){
            buttonClick.play();
        }
        
        function lineClearSound(){
            clearSound.play();
        }

        function draw() {  
            context.fillStyle = "#000";  
            context.fillRect(0, 0, canvas.width, canvas.height);  
            drawMatrix(arena, {x: 0, y: 0});  
            drawGhostPiece();
            drawMatrix(player.matrix, player.pos);  
        }  
        function merge(arena, player) {  
            player.matrix.forEach((row, y) => {  
            row.forEach((value, x) => {  
                if (value !== 0) {  
                arena[y + player.pos.y][x + player.pos.x] = value;  
                }  
            });  
        });  
        }  
        function rotate(matrix, dir) {  
            for (let y = 0; y < matrix.length; ++y) {  
                for (let x = 0; x < y; ++x) {  
                    [matrix[x][y], matrix[y][x]] = [matrix[y][x], matrix[x][y]];  
                }  
            }  
            if (dir > 0) {  
                matrix.forEach((row) => row.reverse());  
            } 
            else {  
                matrix.reverse();  
            }  
        }  
        function playerDrop() {
            player.pos.y++;
            if (collide(arena, player)) {
                player.pos.y--;
                merge(arena, player);
                playerReset();
                arenaSweep();
                updateScore();
            }
            dropCounter = 0;
        }
        function playerMove(offset) {  
            player.pos.x += offset;  
            if (collide(arena, player)) {  
                player.pos.x -= offset;  
            }  
        }  

        let shuffledPieces = shufflePieces();

        function shufflePieces() {
            const pieces = "TJLOSZI".split('');
            // Embaralhe as peças usando o algoritmo de Fisher-Yates
            for (let i = pieces.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [pieces[i], pieces[j]] = [pieces[j], pieces[i]];
            }
            return pieces;
        }
        const pieceFrequency = {
            "T": 0,
            "J": 0,
            "L": 0,
            "O": 0,
            "S": 0,
            "Z": 0,
            "I": 0
        };
        function playerReset() {
            const selectedPiece = shuffledPieces.pop();
            
            drawNextPiece(createPiece(shuffledPieces[shuffledPieces.length - 1]));
            
            player.matrix = createPiece(selectedPiece);
            player.pos.y = 0;
            player.pos.x = Math.floor((arena[0].length / 2) - (player.matrix[0].length / 2));
            
            if (collide(arena, player)) {
                gameOver(player.level);
                return;
            }
            pieceFrequency[selectedPiece]++;

            shuffledPieces.unshift(selectedPiece);
        }


        function playerRotate(dir) {  
            const pos = player.pos.x;  
            let offset = 1;  
            rotate(player.matrix, dir);  
            while (collide(arena, player)) {  
                player.pos.x += offset;  
                offset = -(offset + (offset > 0 ? 1 : -1));  
                if (offset > player.matrix[0].length) {  
                    rotate(player.matrix, -dir);  
                    player.pos.x = pos;
                    return;  
                }  
            }  
        }
        function start(){
            arena.forEach((row) => row.fill(0));
            playerReset();
            update(); 
            document.getElementById('gameOverScreen').style.display = 'none';
            dropInterval = 500;     
            player.score = 0;
            updateScore();
            startLevelUpdate()
            event.preventDefault();
        }
        function showGameOver() {
            document.getElementById('gameOverScreen').style.display = 'block';
        }
        // Defina uma variável para controlar o intervalo de atualização do nível
        let levelUpdateInterval;

        // Função para atualizar o nível do jogador com base no tempo decorrido
        function updateLevel() {
            player.level++; // Aumenta o nível do jogador
            dropInterval -= 20; // Reduz o intervalo de queda para aumentar a velocidade do jogo
            showLevel(); // Atualiza a exibição do nível
        }
        // Função para iniciar o intervalo de atualização do nível
        function startLevelUpdate() {
            levelUpdateInterval = setInterval(updateLevel, 20000); // Atualiza o nível a cada 20 segundos
        }

        // Função para parar o intervalo de atualização do nível (se necessário)
        function stopLevelUpdate() {
            clearInterval(levelUpdateInterval);
        }

        // Função para exibir o nível do jogador
        function showLevel() {
            let nivelJogador = String(player.level).padStart(3, '0');
            document.getElementById("nivel").innerText = "Level: " + nivelJogador;
        }
        function gameOver(nivelJogador) {
            gameOverSound.play();
            showGameOver();
            console.log("Game Over!");
            dropInterval = 9999999;
            player.pos.y = -10;
            stopLevelUpdate()
            let playerName = prompt("Digite seu nome:");
            let playerPartnerName = prompt("Digite o seu sobrenome:");

            playerName = playerName.substring(0, 14);
            playerPartnerName = playerPartnerName.substring(0, 14);

            const date = new Date().toLocaleDateString();
            const score = player.score;


            addScoreToTable(playerName, playerPartnerName, nivelJogador, score, date);

            saveScoreboardData();
        }
        function playerHardDrop() {
            const originalPos = { ...player.pos };
            while (!collide(arena, player)) {
                player.pos.y++;
            }
            player.pos.y--;
            if (!collide(arena, player)) {
                var moveDelay = 100;
                let currentTime = performance.now();
                let allowMove = true;

                const moveHandler = (event) => {
                    if (allowMove) {
                        if (event.keyCode === 37) { 
                            playerMove(-1);
                            allowMove = false; 
                        } else if (event.keyCode === 39) { 
                            playerMove(1);
                            allowMove = false; 
                        }
                    }
                };

                document.addEventListener("keydown", moveHandler);

                setTimeout(() => {
                    document.removeEventListener("keydown", moveHandler);
                }, moveDelay);
            }
        }

        function drawGhostPiece() {
            let ghostPiecePosition = { ...player.pos };
            while (!collide(arena, { matrix: player.matrix, pos: { ...ghostPiecePosition } })) {
                ghostPiecePosition.y++;
            }
            ghostPiecePosition.y--;

            player.matrix.forEach((row, y) => {  
                row.forEach((value, x) => {  
                    if (value !== 0) {
                        context.fillStyle = 'rgba(255, 255, 255, 0.2)';
                        context.fillRect(x + ghostPiecePosition.x, y + ghostPiecePosition.y, 1, 1);
                    }
                });
            });
        }

        function addScoreToTable(playerName, playerPartnerName, nivelJogador, score, date) {
            if (scoreboardTable) {
                const deleteButton = `<button class="botao-de-exclusao" onclick="deleteScore(event)"></button>`;
                scoreboardTable.row.add([
                    playerName,
                    playerPartnerName,
                    nivelJogador,
                    score,
                    date,
                    deleteButton,
                ])  .draw(); 
            }
        }
        function deleteScore(event) {
            const row = event.target.closest('tr');
            const rowIndex = scoreboardTable.row(row).index(); // Obtém o índice da linha na tabela
            const data = JSON.parse(localStorage.getItem('scoreboardData'));
            if (data) {
                data.splice(rowIndex, 1); // Remove os dados associados ao índice da linha
                localStorage.setItem('scoreboardData', JSON.stringify(data));
            }
            scoreboardTable.row(row).remove().draw();
        }
        function loadScoreboardData() {
            const data = localStorage.getItem('scoreboardData');
            if (data) {
                const scoreboardData = JSON.parse(data);
                scoreboardData.forEach(row => {
                    addScoreToTable(row[0], row[1], row[2], row[3], row[4], row[5]);
                });
            }
        }
        function saveScoreboardData() {
            const data = scoreboardTable.rows().data().toArray();
            localStorage.setItem('scoreboardData', JSON.stringify(data));
        }
        function showControls() {
            controlsBox.style.display = "block";
        }
        let dropCounter = 0;  
        let dropInterval = 1000;  
        let lastTime = 0;  
        function update(time = 0) {  
            const deltaTime = time - lastTime;  
            dropCounter += deltaTime;  
            if (dropCounter > dropInterval) {  
                playerDrop();  
            }  
            lastTime = time;  
            draw();  
            requestAnimationFrame(update);  
        }  
        function updateScore() {  
            let formattedScore = String(player.score).padStart(4, '0');  
            document.getElementById("score").innerText = "Score: " + formattedScore;  
        } 
        document.addEventListener("keydown", (event) => {  
            if (event.keyCode === 37) {  
                playerMove(-1);  
            } 
            else if (event.keyCode === 39) {  
                playerMove(1);  
            } 
            else if (event.keyCode === 40) {  
                playerDrop();  
            } 
            else if (event.keyCode === 65) {  
                playerRotate(-1);  
            } 
            else if (event.keyCode === 68) {  
                playerRotate(1);  
            }  
            else if (event.keyCode === 32) { // Tecla de espaço para hard drop
                playerHardDrop();
                tetrisDrop.play();
            }
        });  
        const arenaNextPiece = createMatrix(5, 5);
        const arena = createMatrix(12, 20);  
        const player = {  
            pos: { x: 0, y: 0 },  
            matrix: null,  
            score: 0,  
            level: 0,
        };
        updateScore();
        showLevel();
    </script>
</body>
</html>